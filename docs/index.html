<!DOCTYPE html>
<html>
  <head>
    <title>tsumari unofficial</title>
    <style>
      html, body {
        height: 100%;
        margin: 0;
        padding: 0;
      }
      #map {
        height: 100%;
      }
    </style>
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no" />
    <script src="https://code.jquery.com/jquery-1.11.3.min.js"></script>
  </head>
  <body>
    <div id="map"></div>
    <script>
      var inited = false;
      function loadJson() {
        $(function () {
          // jsonファイルの読み込み
          $.ajax({
            url: 'test.json',
            cache: false,
            dataType: 'json',
            success: function (json) {
              var data = parseJson(json);
              initMap(data);
            }
          });
        });
      }
      function initMap(data) {
        var map = new google.maps.Map(document.getElementById('map'), {
          center: {lat: 37.1328367, lng: 138.7509946},
          zoom: 15
        });
        var infoWindow = new google.maps.InfoWindow();
        for (var i = 0; i < data.length; i++) {
          var d = data[i];
          var content = d.name + '<br>' + d.area+ '<br>' + d.category;
          var marker = new google.maps.Marker({
              position: new google.maps.LatLng(d.lat, d.lng),
              data: d,
              map: map
          });
          google.maps.event.addListener(
            marker,
            'click',
            function(e) {
              var url = 'http://www.echigo-tsumari.jp' + this.data.url;
              var img = this.data.img.replace(/(src=\")/, "$1http://www.echigo-tsumari.jp");
              var content = this.data.category + ': ' + '<a href="' + url + '" target="_blank">' + this.data.name + '</a>' + '<br>' + img + '<br>' + this.data.area;
              infoWindow.setContent(content);
              infoWindow.open(map, this);
            }
          );
          google.maps.event.addListener(
            map,
            'click',
            function (e) {
              infoWindow.close();  
            }
          );
        }
      }

      function parseJson(json) {
        var data = [];
        for (var i = 0; i < json.length; i++) {
          var j = json[i];
          if (j[1] != null && j[2] != null) {
            data.push(
              {
                name: j[0],
                lat: j[1],
                lng: j[2],
                img: j[3],
                area: j[4],
                url: j[5],
                icon: j[6],
                category: j[7]
              }
            );
          }
          
        }
        return data;
      }
    </script>
    <script async defer
        src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBU4mLWlSRmuW1B9mgCB-hkY38-dxmPmsw&callback=loadJson"></script>
  </body>
</html>
